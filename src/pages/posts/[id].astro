---
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";

export const prerender = false;

const { id } = Astro.params;

// üîê Auth
const accessToken = Astro.cookies.get("sb-access-token")?.value;
let user = null;

if (accessToken) {
  const { data } = await supabase.auth.getUser(accessToken);
  user = data.user;
}

// üìå Obtener post
const { data: post, error: postError } = await supabase
  .from("Post")
  .select("*")
  .eq("id", Number(id))
  .single();

if (postError || !post) {
  throw new Error("Post not found");
}

// üí¨ Obtener comments
const { data: comments } = await supabase
  .from("Comment")
  .select("*")
  .eq("post_id", Number(id))
  .order("created_at", { ascending: true });
---

<Layout title={post.title}>
  <main class="max-w-3xl mx-auto px-6 py-16">

    <!-- Post -->
    <article class="mb-16">
      <h1 class="text-4xl font-semibold text-green-900">
        {post.title}
      </h1>

      <p class="text-sm text-green-900/60 mt-2">
        By {post.author_name} ¬∑ {new Date(post.created_at).toLocaleDateString()}
      </p>

      <div class="mt-8 text-green-900 leading-relaxed whitespace-pre-line">
        {post.content}
      </div>
    </article>

{/* Edit post (solo si es el due√±o) */}
{user && post.user_id === user.id && (
  <section class="mb-16">
    <div class="bg-gray-50 border border-gray-200 rounded-2xl shadow-sm p-8">
      <h2 class="text-2xl font-semibold text-green-900 mb-6">
        Edit post
      </h2>

      <form action="/api/auth/posts/update" method="post" class="space-y-6">
        <input type="hidden" name="id" value={post.id} />

        <div>
          <label class="block text-sm font-medium text-green-900 mb-1">
            Title
          </label>
          <input
            type="text"
            name="title"
            value={post.title}
            required
            class="w-full border border-green-900/20 rounded-md px-3 py-2
                   focus:outline-none focus:border-green-700"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-green-900 mb-1">
            Content
          </label>
          <textarea
            name="content"
            rows="10"
            required
            class="w-full border border-green-900/20 rounded-md px-3 py-2
                   focus:outline-none focus:border-green-700"
          >{post.content}</textarea>
        </div>

        <div class="flex items-center gap-4">
          <button
            type="submit"
            class="bg-green-700 hover:bg-green-800 text-white
                   px-5 py-2 rounded-md transition"
          >
            Save changes
          </button>

          <form action="/api/auth/posts/delete" method="post">
            <input type="hidden" name="id" value={post.id} />
            <button type="submit" class="text-sm text-red-600 hover:underline">
              Delete post
            </button>
          </form>
        </div>
      </form>
    </div>
  </section>
)}

    

    <!-- Comments -->
    <section>
      <h2 class="text-2xl font-semibold text-green-900 mb-6">
        Comments
      </h2>

      {comments?.length ? (
  <div class="space-y-4">
    {comments.map((c) => (
      <div class="bg-white border border-green-900/10 rounded-lg p-4">
        <div class="flex items-start justify-between gap-4">
          <div>
            <p class="text-sm text-green-900 font-medium">{c.author_name}</p>
            <p class="text-green-900/80 mt-1 whitespace-pre-line">{c.content}</p>
            <p class="text-xs text-green-900/50 mt-2">
              {new Date(c.created_at).toLocaleDateString()}
            </p>
          </div>

          {user && c.user_id === user.id && (
            <div class="flex items-center gap-3">
              <!-- Edit (simple inline) -->
              <details class="text-right">
                <summary class="cursor-pointer text-sm underline hover:text-green-700">
                  Edit
                </summary>

                <form action="/api/auth/comments/update" method="post" class="mt-3 space-y-2">
                  <input type="hidden" name="id" value={c.id} />
                  <input type="hidden" name="post_id" value={post.id} />

                  <textarea
                    name="content"
                    required
                    class="w-64 border border-green-900/20 rounded-lg p-2 text-sm
                           focus:outline-none focus:border-green-700"
                  >{c.content}</textarea>

                  <button
                    type="submit"
                    class="w-full bg-green-700 hover:bg-green-800 text-white py-2 rounded-md text-sm"
                  >
                    Save
                  </button>
                </form>
              </details>

              <!-- Delete -->
              <form action="/api/auth/comments/delete" method="post">
                <input type="hidden" name="id" value={c.id} />
                <input type="hidden" name="post_id" value={post.id} />
                <button type="submit" class="text-sm underline hover:text-red-600">
                  Delete
                </button>
              </form>
            </div>
          )}
        </div>
      </div>
    ))}
  </div>
) : (
  <p class="text-green-900/60">No comments yet.</p>
)}
    </section>

    <!-- Add comment -->
    <section class="mt-12">
      {user ? (
        <form
          action="/api/auth/comments/create"
          method="post"
          class="space-y-4"
        >
          <input type="hidden" name="post_id" value={post.id} />

          <textarea
            name="content"
            required
            placeholder="Write your comment‚Ä¶"
            class="w-full border border-green-900/20 rounded-lg p-3
                   focus:outline-none focus:border-green-700"
          ></textarea>

          <button
            type="submit"
            class="bg-green-700 hover:bg-green-800 text-white
                   px-5 py-2 rounded-md"
          >
            Post comment
          </button>
        </form>
      ) : (
        <p class="text-green-900/70">
          <a href="/signin" class="underline text-green-800">
            Sign in
          </a>
          to leave a comment.
        </p>
      )}
    </section>

  </main>
</Layout>
