---
import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";

export const prerender = false;

const { data: posts, error } = await supabase
  .from("Post")
  .select("id, title, content, author_name, created_at")
  .order("created_at", { ascending: false });

if (error) {
  console.log("Fetch posts error:", error);
}
---

<Layout title="Posts">
  <main class="max-w-4xl mx-auto md:w-205 px-6 py-14">
    <h1 class="text-3xl font-semibold text-green-900">Last posts</h1>
    

    {error && (
      <p class="mt-4 text-red-600"> Could not load posts. </p>
    )}

    <div class="mt-10 space-y-6 ">
      {posts?.length ? (
        posts.map((p) => (
          <a href={`/posts/${p.id}`} class="block bg-white border border-green-900/10 rounded-xl p-6 hover:bg-[#DAFFA8] hover:shadow-sm transition"
          >
            <h2 class="text-xl font-semibold text-green-900">{p.title}</h2>

            <p class="text-sm text-green-900/60 mt-1">
              {p.author_name ?? "Unknown author"} ·{" "}
              {new Date(p.created_at).toLocaleDateString()}
            </p>

            <p class="mt-4 text-green-900/80">
              {p.content?.slice(0, 180)}
              {p.content && p.content.length > 180 ? "..." : ""}
            </p>

            <p class="mt-5 text-sm text-green-800 underline">
              Read & comment →
            </p>
          </a>
        ))
      ) : (
        <p class="mt-6 text-green-900/70">No posts yet.</p>
      )}
    </div>
  </main>
</Layout>
